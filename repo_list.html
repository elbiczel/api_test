<!doctype html>
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
    <script src="http://underscorejs.org/underscore-min.js" type="text/javascript"></script>
    <script src="js/gh3.js" type="text/javascript"></script>
    <script type="text/javascript">
        var login = "elbiczel"; // TODO(elbiczel): retrieve username from url parameter
        var user = new Gh3.User(login);
        var repositories = new Gh3.Repositories(user);
        var renderRepos = function(repos) {
            var list = $('<ul>');
            var liElements = _.map(repos, function(repo) {
                var li = $('<li>').addClass('repo').addClass('closed');
                var repoName = repo.name;
                li.attr('x-repo', repoName);
                li.html($('<div>').addClass('title').html(repoName));
                return li;
            });
            _.each(liElements, function(liElement) {
                list.append(liElement); 
            });
            return list;
        }
        var closeRepository = function($repo) {
            $repo.find('li').remove();
            $repo.addClass('closed').removeClass('opened');
        }
        var attachClickHandlerToRepoElement = function($li) {
            $li.click() {
                var $this = $(this);
                var path = $this.attr('x-content').path;
                if ($this.hasClass('file')) {
                    alert('open file: ' + path);    
                } else if ($this.hasClass('dir')) {
                    alert('open directory: ' + path);    
                }
            }
        }
        var renderContentElem = function(content) {
            $li = $('<li>').html($('<div>').html(content.path)).addClass(content.type);
            $li.attr('x-content', content);
            attachClickHandlerToRepoElement($li);
            return $li;
        }
        var openRepository = function($repo) {
            var repo = repositories.getRepositoryByName($repo.attr('x-repo'));
            $ul = $('<ul>').addClass('repo_content');
            repo.fetch(function() {
                repo.fetchBranches(function() {
                    var master = repo.getBranchByName('master'); // TODO(biczel): allow branch switching.
                    master.fetchContents(function() {
                        master.eachContent(function (content) {
                            var $contentElem = renderContentElem(content);
                            $contentElem.appendTo($ul);
                        });
                        $ul.appendTo($repo);
                    });
                });    
            });
            $repo.addClass('opened').removeClass('closed');    
        }
        var addClickHandlers = function() {
            $('#repo_list li .title').click(function() {
                $parent = $(this).parents('li');
                if ($parent.hasClass('opened')) {
                    closeRepository($parent);    
                } else {
                    openRepository($parent);    
                }
            });
        };
        var listRepos = function() {
            var repos = repositories.getRepositories();
            var renderedRepos = renderRepos(repos);
            renderedRepos.appendTo('#repo_list');
            addClickHandlers();
        };
        repositories.fetch({ page: 1, per_page: 500 }, "first", listRepos);
    </script>
  </head>
  <body>
  <nav id="repo_list">
  </nav>
  </body>
</html>
