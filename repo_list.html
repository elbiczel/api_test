<!doctype html>
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js" type="text/javascript"></script>
    <script src="http://underscorejs.org/underscore-min.js" type="text/javascript"></script>
    <script src="js/gh3.js" type="text/javascript"></script>
    <script type="text/javascript">
        var login = "elbiczel"; // TODO(elbiczel): retrieve username from url parameter
        var user = new Gh3.User(login);
        var repositories = new Gh3.Repositories(user);
        var renderRepos = function(repos) {
            var list = $('<ul>');
            var liElements = _.map(repos, function(repo) {
                var li = $('<li>').addClass('repo').addClass('closed');
                var repoName = repo.name;
                li.attr('x-repo', repoName);
                li.html(repoName);
                return li;
            });
            _.each(liElements, function(liElement) {
                list.append(liElement); 
            });
            return list;
        }
        var closeRepository = function($repo) {
            $repo.html($repo.attr('x-repo'));
            $repo.addClass('closed').removeClass('opened');
        }
        var renderContentElem(content) {
            $li = $('<li>').html(content.path).addClass(content.type);
            $li.attr('x-content', content);
            return $li;
        }
        var openRepository = function($repo) {
            var repo = repositories.getRepositoryByName($repo.attr('x-repo'));
            $ul = $('<ul>').addClass('repo_content');
            repo.fetch(function() {
                repo.fetchBranches(function() {
                    var master = repo.getBranchByName('master'); // TODO(biczel): allow branch switching.
                    master.fetchContents(function() {
                        master.eachContent(function (content) {
                            var $contentElem = renderContentElem(content);
                            $contentElem.appendTo($ul);
                        });
                        $ul.appendTo($repo);
                    });
                });    
            });
            $repo.addClass('opened').removeClass('closed');    
        }
        var addClickHandlers = function() {
            $('#repo_list li').click(function() {
                $this = $(this);
                if ($this.hasClass('opened')) {
                    closeRepository($this);    
                } else {
                    openRepository($this);    
                }
            });
        };
        var listRepos = function() {
            var repos = repositories.getRepositories();
            var renderedRepos = renderRepos(repos);
            renderedRepos.appendTo('#repo_list');
            addClickHandlers();
        };
        repositories.fetch({ page: 1, per_page: 500 }, "first", listRepos);
    </script>
  </head>
  <body>
  <nav id="repo_list">
  </nav>
  </body>
</html>
